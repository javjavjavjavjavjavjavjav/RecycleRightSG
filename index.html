<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RecycleRight SG</title>
  <style>
    :root{
      --bg1:#f6f3ea;
      --bg2:#e7f1ea;
      --bg3:#d7e7dc;
      --surface:#ffffffcc;
      --surface2:#f7fbf6;
      --text:#1c2b22;
      --muted:#526a5c;
      --border:rgba(28,43,34,.14);
      --shadow: 0 14px 30px rgba(18, 30, 24, .12);
      --radius:18px;

      --accent:#2f6f4e;
      --accent2:#5aa173;
      --chip:#e8f3ea;

      --ok:#1f8a4c;
      --warn:#b7791f;
      --bad:#b33a3a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 600px at 15% 10%, var(--bg2) 0%, rgba(231,241,234,0) 60%),
        radial-gradient(900px 600px at 85% 20%, var(--bg3) 0%, rgba(215,231,220,0) 55%),
        linear-gradient(140deg, var(--bg1), #f2f7f2 45%, #eef6f0);
    }

    .wrap{max-width:1180px;margin:0 auto;padding:18px}

    .top{
      display:flex;
      justify-content:center;
      text-align:center;
      padding:14px 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 5;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      align-items:center;
    }

    .brand .name{font-weight:850; letter-spacing:.2px; font-size:18px}
    .brand .tag{color:var(--muted); font-size:12.5px}

    /* 3-column layout (Forum | Main | Right) */
    .grid{
      margin-top:14px;
      display:grid; gap:14px;
      grid-template-columns: .85fr 1.35fr .95fr;
      align-items:start;
    }
    @media (max-width: 1050px){
      .grid{grid-template-columns:1fr}
      .top{position:relative; top:auto}
    }

    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }

    h2{margin:0 0 10px 0; font-size:18px}
    p{margin:0 0 10px 0; color:var(--muted); line-height:1.45}

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(28,43,34,.10);
    }
    .sectionTitle h3{margin:0; font-size:14.5px}
    .sectionTitle span{color:var(--muted); font-size:12.5px}

    .searchRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    .input{
      flex: 1 1 320px;
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--border);
      background: var(--surface2);
      border-radius: 14px;
      padding:10px 12px;
    }
    .input input{
      flex:1; background:transparent; border:none; outline:none;
      color:var(--text); font-size:15px;
    }

    .btn{
      border:1px solid rgba(47,111,78,.25);
      background: linear-gradient(180deg, rgba(90,161,115,.18), rgba(47,111,78,.12));
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:800;
      cursor:pointer;
      transition: transform .05s ease, filter .15s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      text-decoration:none;
    }
    .btn:hover{filter: brightness(1.02)}
    .btn:active{transform: scale(.98)}
    .btn.secondary{
      border:1px solid var(--border);
      background: rgba(232,243,234,.75);
      font-weight:800;
    }

    .hint{font-size:12.5px;color:var(--muted);margin-top:8px}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .chip{
      border:1px solid rgba(47,111,78,.22);
      background: rgba(232,243,234,.90);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      color:var(--text);
      user-select:none;
    }
    .chip:hover{background: rgba(232,243,234,1)}

    .result{
      margin-top:14px;
      border:1px solid rgba(47,111,78,.18);
      background: rgba(247,251,246,.95);
      border-radius: 16px;
      padding:14px;
      display:none;
    }
    .result.show{display:block}

    /* BIG decision banner */
    .decisionBanner{
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border: 1px solid rgba(28,43,34,.12);
      background: rgba(255,255,255,.7);
      margin-bottom: 12px;
    }
    .decisionText{
      font-weight:1000;
      letter-spacing:.4px;
      font-size:18px;
    }
    .decisionBadge{
      font-weight:1000;
      font-size:12px;
      border-radius:999px;
      padding:8px 12px;
      border: 1px solid rgba(28,43,34,.12);
      background: rgba(255,255,255,.75);
      white-space:nowrap;
    }
    .decisionBanner.ok{ outline: 3px solid rgba(31,138,76,.18); }
    .decisionBanner.bad{ outline: 3px solid rgba(179,58,58,.18); }
    .decisionBanner.warn{ outline: 3px solid rgba(183,121,31,.18); }
    .decisionText.ok{color: var(--ok)}
    .decisionText.bad{color: var(--bad)}
    .decisionText.warn{color: var(--warn)}

    .small{font-size:12.5px;color:var(--muted)}
    .itemName{font-weight:900; font-size:16px; margin:0}
    .why{margin-top:8px; color:var(--muted)}
    ul{margin:10px 0 0 18px; color:var(--muted)}
    li{margin:6px 0}

    .foot{
      margin-top:14px;
      color:var(--muted);
      font-size:12.5px;
    }
    .kbd{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      background: rgba(28,43,34,.06);
      border:1px solid rgba(28,43,34,.10);
      padding:2px 6px; border-radius:8px;
      color: var(--text);
    }

    .rowItem{
      border:1px solid rgba(47,111,78,.16);
      background: rgba(247,251,246,.92);
      border-radius: 16px;
      padding:12px;
    }
    .rowItem h3{margin:0 0 6px 0; font-size:14.5px}
    .rowItem ul{margin-top:6px}

    /* Photo upload UI */
    .uploadBox{
      margin-top:10px;
      border:1px dashed rgba(47,111,78,.30);
      background: rgba(232,243,234,.55);
      border-radius: 16px;
      padding:12px;
    }
    .uploadRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    /* hide real file input */
    .fileHidden{
      position:absolute;
      left:-9999px;
      width:1px;height:1px;opacity:0;
    }

    .fileMeta{
      font-size:12.5px;
      color:var(--muted);
      padding:8px 10px;
      border:1px solid rgba(28,43,34,.10);
      background: rgba(255,255,255,.65);
      border-radius: 12px;
      flex: 1 1 210px;
      min-width: 210px;
    }

    .previewWrap{
      margin-top:10px;
      display:none;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .previewWrap.show{display:flex}
    .preview{
      width:140px; height:140px;
      border-radius: 16px;
      border:1px solid rgba(28,43,34,.10);
      background: rgba(255,255,255,.65);
      object-fit: cover;
    }
    .previewMeta{min-width:200px; flex:1}
    .note{
      margin-top:6px;
      font-size:12.5px;
      color:var(--muted);
    }

    .qrWrap{
      margin-top:12px;
      display:flex;
      justify-content:center;
    }
    .qrImg{
      width:240px;
      height:auto;
      max-width:100%;
      display:block;
      border-radius:16px;
      border:1px solid rgba(47,111,78,.18);
      background: rgba(255,255,255,.7);
      padding:10px;
    }
    .qrCard{ padding:16px; }

    /* Forum */
    .field{
      width:100%;
      border:1px solid rgba(28,43,34,.10);
      background: rgba(255,255,255,.75);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
      color:var(--text);
    }
    textarea.field{ min-height:90px; resize:vertical; }
    .forumList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:320px;
      overflow:auto;
      padding-right:4px;
    }
    .post{
      border:1px solid rgba(47,111,78,.16);
      background: rgba(247,251,246,.92);
      border-radius: 16px;
      padding:10px;
    }
    .postTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .tagPill{
      font-size:12px;
      font-weight:900;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(28,43,34,.12);
      background: rgba(255,255,255,.7);
    }
    .tagChat{ color: var(--accent); }
    .tagComplain{ color: var(--bad); }
    .postMsg{ color: var(--text); line-height:1.35; }
    .postMeta{ color: var(--muted); font-size:12px; }

    /* Bin finder */
    .miniRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .miniRow .field{ flex:1 1 140px; min-width: 140px; }
    .binOut{
      margin-top:10px;
      border:1px solid rgba(47,111,78,.16);
      background: rgba(247,251,246,.92);
      border-radius: 16px;
      padding:12px;
      display:none;
    }
    .binOut.show{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="name">RecycleRight SG</div>
        <div class="tag">Correct recycling ‚Ä¢ Reduce contamination ‚Ä¢ Under 10 seconds</div>
      </div>
    </header>

    <main class="grid">
      <!-- LEFT SIDEBAR -->
      <aside class="card">
        <h2>Community Forum</h2>
        <p>Chat or report issues</p>

        <div class="miniRow" style="margin-top:6px;">
          <select id="forumType" class="field" aria-label="Post type">
            <option value="chat">Chat</option>
            <option value="complaint">Complaint</option>
          </select>
          <input id="forumName" class="field" type="text" placeholder="Name (optional)" maxlength="20" />
        </div>

        <div style="margin-top:10px;">
          <textarea id="forumMsg" class="field" placeholder="Type your message..." maxlength="240"></textarea>
        </div>

        <div class="miniRow">
          <button class="btn" id="postBtn">Post</button>
          <button class="btn secondary" id="clearPostsBtn">Clear posts</button>
        </div>

        <div class="forumList" id="forumList" aria-live="polite"></div>

        <div class="sectionTitle">
          <h3>Nearest Recycling Bins</h3>
        </div>

        <p class="small" style="margin-top:8px;">Enter a Singapore postal code (6 digits). We estimate region + nearby bins.</p>

        <div class="miniRow">
          <input id="postalInput" class="field" type="text" inputmode="numeric" placeholder="e.g. 520123" maxlength="6" />
          <button class="btn" id="postalBtn">Find</button>
        </div>

        <div id="binOut" class="binOut"></div>
      </aside>

      <!-- MAIN -->
      <section class="card">
        <h2>Instant Item Checker</h2>
        <p>Type an item (or tap a common item). Get a clear answer and quick contamination tips immediately.</p>

        <div class="searchRow">
          <div class="input" role="search">
            üîé
            <input id="itemInput" type="text" placeholder="e.g., plastic bottle, plastic straw, battery" autocomplete="off" />
          </div>
          <button class="btn" id="checkBtn">Check item</button>
          <button class="btn secondary" id="clearBtn">Clear</button>
        </div>

        <div class="hint">Fast tip: press <span class="kbd">Enter</span> to check.</div>

        <div class="chips" aria-label="Common items">
          <div class="chip" data-item="Plastic bottle">Plastic bottle</div>
          <div class="chip" data-item="Aluminium can">Aluminium can</div>
          <div class="chip" data-item="Paper">Paper</div>
          <div class="chip" data-item="Cardboard">Cardboard</div>
          <div class="chip" data-item="Glass bottle">Glass bottle</div>
          <div class="chip" data-item="Food container (dirty)">Food container (dirty)</div>
          <div class="chip" data-item="Food container (clean)">Food container (clean)</div>
          <div class="chip" data-item="Tissue">Tissue</div>
          <div class="chip" data-item="Battery">Battery</div>
          <div class="chip" data-item="Plastic bag">Plastic bag</div>
          <div class="chip" data-item="Plastic straw">Plastic straw</div>
          <div class="chip" data-item="Plastic cutlery">Plastic cutlery</div>
          <div class="chip" data-item="Styrofoam">Styrofoam</div>
          <div class="chip" data-item="Coffee cup">Coffee cup</div>
        </div>

        <!-- Photo Upload -->
        <div class="sectionTitle">
          <h3>Upload Photo</h3>
          <span>works on phone + laptop</span>
        </div>

        <div class="uploadBox">
          <div class="uploadRow">
            <input class="fileHidden" id="photoInput" type="file" accept="image/*" capture="environment" />

            <!-- custom label button -->
            <label class="btn" for="photoInput">üì∑ Take/Upload Photo</label>

            <!-- shows file name -->
            <div class="fileMeta" id="fileMeta">No photo selected.</div>

            <button class="btn" id="photoCheckBtn">Identify photo</button>
            <button class="btn secondary" id="photoClearBtn">Remove photo</button>
          </div>

          <div id="previewWrap" class="previewWrap">
            <img id="previewImg" class="preview" alt="Uploaded preview" />
            <div class="previewMeta">
              <div class="small" id="photoStatus">No photo selected.</div>
              <div class="note">
                Photo AI is optional (Teachable Machine). If unsure, use the text checker.
              </div>
            </div>
          </div>
        </div>

        <div id="result" class="result" aria-live="polite"></div>

        <div class="foot">
          <div>Privacy: this page stores nothing. No accounts, no tracking.</div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h2>Why RecycleRight SG is better</h2>
        <p><b>Existing apps</b> often focus on locations and rewards. <b>RecycleRight SG</b> focuses on correct action and stopping contamination on-the-spot.</p>

        <div class="rowItem" style="margin-top:10px;">
          <h3>Key Features</h3>
          <ul>
            <li>Instant item checker (under 10 seconds)</li>
            <li>Contamination tips in simple language</li>
            <li>No login, no ads, no download</li>
            <li>QR access at the point of disposal</li>
            <li>Photo upload for quick identification</li>
            <li>Community forum + bin locator (demo)</li>
          </ul>
        </div>

        <div class="rowItem qrCard" style="margin-top:10px;">
          <h3>Scan to use RecycleRight SG</h3>
          <p class="small">Open instantly at the bin. No download needed.</p>
          <div class="qrWrap">
            <img src="./qrcode.jpg" alt="RecycleRight SG QR code" class="qrImg">
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- OPTIONAL AI (Photo identification) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <script>
    // =========================
    // 1) TEXT-BASED RULES (no backend)
    // =========================
    const RULES = [
      // Recyclables
      {
        keys: ["plastic bottle", "pet bottle", "water bottle", "drink bottle"],
        decision: "RECYCLE",
        bin: "Recycling (Blue Bin)",
        why: "Clean plastic bottles are recyclable.",
        tips: ["Empty and rinse.", "No food/liquid inside.", "If very dirty, use General Waste."]
      },
      {
        keys: ["aluminium can", "aluminum can", "can", "soda can", "beer can"],
        decision: "RECYCLE",
        bin: "Recycling (Blue Bin)",
        why: "Clean metal cans are recyclable.",
        tips: ["Empty and rinse.", "Crush if possible (optional).", "If oily/dirty, use General Waste."]
      },
      {
        keys: ["paper", "newspaper", "worksheet", "book", "magazine"],
        decision: "RECYCLE",
        bin: "Recycling (Blue Bin)",
        why: "Clean, dry paper is recyclable.",
        tips: ["Keep it dry.", "No food-stained paper.", "Remove plastic covers if possible."]
      },
      {
        keys: ["cardboard", "box", "carton box", "shipping box"],
        decision: "RECYCLE",
        bin: "Recycling (Blue Bin)",
        why: "Clean, dry cardboard is recyclable.",
        tips: ["Flatten boxes.", "Keep it dry.", "Dirty parts go General Waste."]
      },
      {
        keys: ["glass", "glass bottle", "glass jar"],
        decision: "RECYCLE",
        bin: "Recycling (Blue Bin)",
        why: "Glass bottles/jars are recyclable when clean.",
        tips: ["Empty and rinse.", "No ceramics/mirrors.", "If broken, wrap and dispose safely (General Waste)."]
      },
      {
        keys: ["milk carton", "drink carton", "tetra pak", "tetrapak", "juice carton"],
        decision: "RECYCLE",
        bin: "Recycling (Blue Bin)",
        why: "Beverage cartons can be recycled if emptied and rinsed.",
        tips: ["Empty and rinse.", "Flatten if possible.", "If heavily contaminated, use General Waste."]
      },
      {
        keys: ["food container (clean)", "clean container", "rinsed container", "takeaway container (clean)", "plastic container (clean)"],
        decision: "RECYCLE",
        bin: "Recycling (Blue Bin)",
        why: "Clean rigid plastic containers are usually recyclable.",
        tips: ["Empty and rinse fully.", "If oily/greasy, use General Waste.", "Remove leftover food."]
      },

      // Not recyclable / General waste
      {
        keys: ["food", "leftover", "rice", "noodles"],
        decision: "GENERAL",
        bin: "General Waste",
        why: "Food waste contaminates recycling.",
        tips: ["Don‚Äôt put food into recycling bins.", "Empty leftovers before recycling containers."]
      },
      {
        keys: ["food container", "dirty container", "greasy container", "oily container", "takeaway container (dirty)"],
        decision: "GENERAL",
        bin: "General Waste",
        why: "Dirty or oily containers contaminate recycling.",
        tips: ["If you can rinse it fully, then recycle.", "If not, use General Waste."]
      },
      {
        keys: ["tissue", "napkin", "wet tissue", "wet wipes", "wipe"],
        decision: "GENERAL",
        bin: "General Waste",
        why: "Used tissues and wipes are not recyclable.",
        tips: ["Tissues are usually contaminated after use.", "Wet wipes are not paper and contaminate recycling."]
      },
      {
        keys: ["plastic bag", "bag"],
        decision: "GENERAL",
        bin: "General Waste (unless special collection exists)",
        why: "Plastic bags jam sorting machines and often contaminate recycling streams.",
        tips: ["Do not place in blue bins.", "Use special collection only if your area has it."]
      },
      {
        keys: ["plastic straw", "straw"],
        decision: "GENERAL",
        bin: "General Waste",
        why: "Straws are small, easily contaminated, and commonly not accepted in mixed recycling.",
        tips: ["Dispose as General Waste.", "If possible, avoid single-use straws."]
      },
      {
        keys: ["plastic cutlery", "fork", "spoon", "knife"],
        decision: "GENERAL",
        bin: "General Waste",
        why: "Small plastic cutlery is often contaminated and not sorted effectively.",
        tips: ["Dispose as General Waste.", "If reusable, wash and reuse instead."]
      },
      {
        keys: ["styrofoam", "foam", "polystyrene"],
        decision: "GENERAL",
        bin: "General Waste",
        why: "Foam items are typically not accepted in mixed recycling.",
        tips: ["Dispose as General Waste.", "Avoid foam packaging if possible."]
      },
      {
        keys: ["coffee cup", "paper cup", "disposable cup"],
        decision: "GENERAL",
        bin: "General Waste",
        why: "Disposable cups often have plastic lining and liquid contamination.",
        tips: ["Dispose as General Waste.", "Use a reusable cup when possible."]
      },

      // Special
      {
        keys: ["battery", "batteries", "power bank", "lithium", "aa battery"],
        decision: "SPECIAL",
        bin: "Special Disposal (E-waste / Battery Bin)",
        why: "Batteries are hazardous and must not go into normal bins.",
        tips: ["Use dedicated battery collection points.", "Do not throw into general waste or recycling."]
      }
    ];

    const input = document.getElementById("itemInput");
    const checkBtn = document.getElementById("checkBtn");
    const clearBtn = document.getElementById("clearBtn");
    const resultEl = document.getElementById("result");

    function normalize(s){
      return (s || "").toLowerCase().trim().replace(/\s+/g, " ");
    }

    function matchRule(q){
      const nq = normalize(q);
      if (!nq) return null;

      for (const r of RULES){
        for (const k of r.keys){
          if (nq.includes(k)) return r;
        }
      }

      // fuzzy-ish match
      const words = nq.split(" ").filter(Boolean);
      let best = null;
      let bestScore = 0;

      for (const r of RULES){
        let score = 0;
        for (const k of r.keys){
          const kw = k.split(" ");
          for (const w of words){
            if (kw.includes(w) && w.length >= 3) score++;
          }
        }
        if (score > bestScore){
          bestScore = score;
          best = r;
        }
      }
      return bestScore >= 2 ? best : null;
    }

    function decisionStyle(decision){
      if (decision === "RECYCLE") return { cls:"ok", txt:"‚úÖ RECYCLE", badge:"Blue Bin" };
      if (decision === "GENERAL") return { cls:"bad", txt:"‚ùå GENERAL WASTE", badge:"Black/General Bin" };
      return { cls:"warn", txt:"‚ö†Ô∏è SPECIAL DISPOSAL", badge:"E-waste / Battery Bin" };
    }

    function esc(s){ return (s || "").replace(/[<>]/g, ""); }

    function renderResult(item, rule, extraLine = ""){
      const d = decisionStyle(rule.decision);
      const safeItem = esc(item);
      const tips = rule.tips.map(t => `<li>${esc(t)}</li>`).join("");

      resultEl.classList.add("show");
      resultEl.innerHTML = `
        <div class="decisionBanner ${d.cls}">
          <div class="decisionText ${d.cls}">${d.txt}</div>
          <div class="decisionBadge">${d.badge}</div>
        </div>

        <p class="itemName">Item: ${safeItem}</p>
        <div class="small">Decision made for on-the-spot disposal (under 10 seconds).</div>
        ${extraLine ? `<div class="small">${esc(extraLine)}</div>` : ``}

        <div class="why" style="margin-top:10px;">
          <b>Dispose in:</b> ${esc(rule.bin)}<br>
          <span class="small">${esc(rule.why)}</span>
        </div>

        <div style="margin-top:10px;"><b>Contamination tips:</b></div>
        <ul>${tips}</ul>
      `;
    }

    function renderUnknown(item, extraLine = ""){
      const safeItem = esc(item);
      resultEl.classList.add("show");
      resultEl.innerHTML = `
        <div class="decisionBanner warn">
          <div class="decisionText warn">‚ö†Ô∏è NOT SURE</div>
          <div class="decisionBadge">Avoid contamination</div>
        </div>

        <p class="itemName">Item: ${safeItem}</p>
        <div class="small">Not in our quick list yet.</div>
        ${extraLine ? `<div class="small">${esc(extraLine)}</div>` : ``}

        <div class="why" style="margin-top:10px;">
          <b>Quick safe rule:</b> If it‚Äôs <b>clean and dry</b> (paper, cans, bottles, cardboard), it‚Äôs usually recyclable.
          If it‚Äôs <b>dirty, wet, or food-stained</b>, use <b>General Waste</b> to avoid contamination.
        </div>

        <div style="margin-top:10px;"><b>Contamination tips:</b></div>
        <ul>
          <li>When in doubt, don‚Äôt contaminate the recycling bin.</li>
          <li>Empty and rinse containers before recycling.</li>
          <li>Keep paper/cardboard dry.</li>
        </ul>
      `;
    }

    function checkText(){
      const q = input.value;
      const nq = normalize(q);
      if (!nq){
        resultEl.classList.remove("show");
        resultEl.innerHTML = "";
        input.focus();
        return;
      }

      const rule = matchRule(nq);
      if (rule) renderResult(q, rule);
      else renderUnknown(q);
    }

    function clearAll(){
      input.value = "";
      resultEl.classList.remove("show");
      resultEl.innerHTML = "";
      input.focus();
    }

    checkBtn.addEventListener("click", checkText);
    clearBtn.addEventListener("click", clearAll);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkText();
      if (e.key === "Escape") clearAll();
    });
    document.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        input.value = chip.dataset.item || "";
        checkText();
      });
    });
    window.addEventListener("load", () => input.focus());

    // =========================
    // 2) PHOTO UPLOAD + OPTIONAL AI
    // =========================
    const TM_URL = "https://teachablemachine.withgoogle.com/models/lad93rVUN/"; // keep yours

    const photoInput = document.getElementById("photoInput");
    const photoCheckBtn = document.getElementById("photoCheckBtn");
    const photoClearBtn = document.getElementById("photoClearBtn");
    const previewWrap = document.getElementById("previewWrap");
    const previewImg = document.getElementById("previewImg");
    const photoStatus = document.getElementById("photoStatus");
    const fileMeta = document.getElementById("fileMeta");

    let tmModel = null;
    let lastObjectURL = null;

    function setPhotoStatus(msg){ photoStatus.textContent = msg; }

    function clearPhoto(){
      photoInput.value = "";
      previewImg.src = "";
      previewWrap.classList.remove("show");
      if (lastObjectURL) URL.revokeObjectURL(lastObjectURL);
      lastObjectURL = null;
      setPhotoStatus("No photo selected.");
      fileMeta.textContent = "No photo selected.";
    }

    async function loadTM(){
      if (!TM_URL) return null;
      if (tmModel) return tmModel;
      const modelURL = TM_URL + "model.json";
      const metadataURL = TM_URL + "metadata.json";
      tmModel = await tmImage.load(modelURL, metadataURL);
      return tmModel;
    }

    function mapTMLabelToTextQuery(label){
      const m = {
        "Plastic Bottle": "plastic bottle",
        "Aluminium Can": "aluminium can",
        "Paper": "paper",
        "Cardboard": "cardboard",
        "Paper/Cardboard": "cardboard",
        "Glass": "glass bottle",
        "Battery": "battery",
        "Tissue": "tissue",
        "Plastic Bag": "plastic bag",
        "Plastic Straw": "plastic straw",
        "Others": "others"
      };
      return m[label] || label.toLowerCase();
    }

    async function identifyPhoto(){
      const file = photoInput.files && photoInput.files[0];
      if (!file){
        setPhotoStatus("Please take/upload a photo first.");
        return;
      }

      if (!TM_URL){
        setPhotoStatus("AI model not configured. Use the text checker above, or set TM_URL.");
        renderUnknown("Uploaded photo", "Tip: Configure Teachable Machine model to auto-identify photos.");
        return;
      }

      try{
        setPhotoStatus("Loading model...");
        const model = await loadTM();

        setPhotoStatus("Identifying...");
        const preds = await model.predict(previewImg);
        preds.sort((a,b) => b.probability - a.probability);
        const top = preds[0];

        const label = top.className;
        const conf = Math.round(top.probability * 100);

        const query = mapTMLabelToTextQuery(label);
        const rule = matchRule(query);

        if (rule){
          renderResult(label, rule, `Photo AI confidence: ${conf}% ‚Ä¢ Please confirm.`);
        } else {
          renderUnknown(label, `Photo AI confidence: ${conf}% ‚Ä¢ If unsure, use General Waste to avoid contamination.`);
        }

        setPhotoStatus(`AI suggests: ${label} (${conf}%).`);
      }catch(err){
        setPhotoStatus("Could not run photo AI. Check TM_URL and internet access.");
        renderUnknown("Uploaded photo", "AI error occurred. Use text checker instead.");
      }
    }

    photoInput.addEventListener("change", () => {
      const file = photoInput.files && photoInput.files[0];
      if (!file){
        clearPhoto();
        return;
      }
      if (lastObjectURL) URL.revokeObjectURL(lastObjectURL);
      lastObjectURL = URL.createObjectURL(file);
      previewImg.src = lastObjectURL;
      previewWrap.classList.add("show");
      setPhotoStatus("Photo ready. Click ‚ÄúIdentify photo‚Äù.");
      fileMeta.textContent = `Selected: ${file.name}`;
    });

    photoCheckBtn.addEventListener("click", identifyPhoto);
    photoClearBtn.addEventListener("click", clearPhoto);

    // =========================
    // 3) COMMUNITY FORUM (DEMO - localStorage only)
    // =========================
    const forumType = document.getElementById("forumType");
    const forumName = document.getElementById("forumName");
    const forumMsg  = document.getElementById("forumMsg");
    const postBtn   = document.getElementById("postBtn");
    const clearPostsBtn = document.getElementById("clearPostsBtn");
    const forumList = document.getElementById("forumList");

    const FORUM_KEY = "rr_forum_posts_v1";

    function loadPosts(){
      try { return JSON.parse(localStorage.getItem(FORUM_KEY) || "[]"); }
      catch { return []; }
    }
    function savePosts(posts){
      localStorage.setItem(FORUM_KEY, JSON.stringify(posts));
    }
    function fmtTime(ts){
      const d = new Date(ts);
      return d.toLocaleString();
    }
    function renderPosts(){
      const posts = loadPosts().slice().reverse(); // newest first
      forumList.innerHTML = posts.length ? "" : `<div class="small">No posts yet. Be the first!</div>`;
      for (const p of posts){
        const tClass = p.type === "complaint" ? "tagComplain" : "tagChat";
        const tText  = p.type === "complaint" ? "Complaint" : "Chat";
        const name = (p.name || "Anonymous").slice(0,20);
        forumList.insertAdjacentHTML("beforeend", `
          <div class="post">
            <div class="postTop">
              <div class="tagPill ${tClass}">${tText}</div>
              <div class="postMeta">${name} ‚Ä¢ ${fmtTime(p.ts)}</div>
            </div>
            <div class="postMsg">${esc(p.msg)}</div>
          </div>
        `);
      }
    }

    postBtn.addEventListener("click", () => {
      const msg = (forumMsg.value || "").trim();
      if (!msg) return;

      const posts = loadPosts();
      posts.push({
        type: forumType.value,
        name: (forumName.value || "").trim(),
        msg,
        ts: Date.now()
      });
      savePosts(posts);

      forumMsg.value = "";
      renderPosts();
    });

    clearPostsBtn.addEventListener("click", () => {
      localStorage.removeItem(FORUM_KEY);
      renderPosts();
    });

    renderPosts();

    // =========================
    // 4) BIN LOCATOR (ROUGH ESTIMATE - DEMO)
    // =========================
    const postalInput = document.getElementById("postalInput");
    const postalBtn = document.getElementById("postalBtn");
    const binOut = document.getElementById("binOut");

    // tiny sample dataset (demo)
    const SAMPLE_BINS = [
      { name:"Tampines Hub (Blue Bin area)", postal:"529684" },
      { name:"Bedok MRT / Interchange area", postal:"465761" },
      { name:"Jurong East MRT area", postal:"609732" },
      { name:"Woodlands MRT area", postal:"738099" },
      { name:"Punggol MRT area", postal:"828868" },
      { name:"Bishan MRT area", postal:"579837" },
      { name:"Ang Mo Kio Hub area", postal:"569933" },
      { name:"Clementi MRT area", postal:"129542" },
      { name:"Toa Payoh MRT area", postal:"319764" },
      { name:"HarbourFront MRT area", postal:"098585" }
    ];

    function regionFromPostal(p){
      const n = parseInt(p.slice(0,2), 10);
      if (isNaN(n)) return "Unknown";
      if (n >= 1 && n <= 8) return "Central / City";
      if (n >= 9 && n <= 14) return "Central / South";
      if (n >= 15 && n <= 18) return "West";
      if (n >= 19 && n <= 28) return "West / Central";
      if (n >= 29 && n <= 38) return "Central";
      if (n >= 39 && n <= 48) return "East";
      if (n >= 49 && n <= 54) return "East / North-East";
      if (n >= 55 && n <= 59) return "North-East";
      if (n >= 60 && n <= 64) return "West";
      if (n >= 65 && n <= 73) return "North";
      if (n >= 74 && n <= 82) return "North / North-East";
      return "Unknown";
    }

    function estimateCount(region){
      // totally rough demo numbers
      const map = {
        "Central / City": 8,
        "Central / South": 7,
        "Central": 7,
        "East": 6,
        "East / North-East": 6,
        "North-East": 6,
        "West": 6,
        "West / Central": 6,
        "North": 5,
        "North / North-East": 5,
        "Unknown": 4
      };
      return map[region] ?? 4;
    }

    function findNearestSamples(postal){
      const target = parseInt(postal, 10);
      const ranked = SAMPLE_BINS
        .map(b => ({...b, diff: Math.abs(parseInt(b.postal,10) - target)}))
        .sort((a,b) => a.diff - b.diff)
        .slice(0,3);
      return ranked;
    }

    function showBins(){
      const p = (postalInput.value || "").trim();
      if (!/^\d{6}$/.test(p)){
        binOut.classList.add("show");
        binOut.innerHTML = `<b>Invalid postal code.</b><div class="small">Please enter 6 digits (e.g. 520123).</div>`;
        return;
      }

      const region = regionFromPostal(p);
      const count = estimateCount(region);
      const nearest = findNearestSamples(p);

      binOut.classList.add("show");
      binOut.innerHTML = `
        <b>Estimate for ${p}</b>
        <div class="small">Region: <b>${region}</b> ‚Ä¢ Approx bins nearby: <b>~${count}</b> (demo estimate)</div>
        <div style="margin-top:10px;"><b>Nearest examples (demo):</b></div>
        <ul>
          ${nearest.map(n => `<li>${esc(n.name)} (${n.postal})</li>`).join("")}
        </ul>
        <div class="small" style="margin-top:8px;">
          Note: This is a rough demo (no live map/API)
        </div>
      `;
    }

    postalBtn.addEventListener("click", showBins);
    postalInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") showBins();
    });
  </script>
</body>
</html>

